version: '3'

vars:
  DEFAULT_TRUFFLEHOG_GITHUBACTION_FILENAME: '{{ .ROOT_DIR }}/.github/workflows/trufflehog.yml'

tasks:
  default:
    cmds:
      - task: ci
      - task: detect

  pre-commit:
    cmd:
      task: detect

  detect:
    desc: Detect secret leak in current repository
    cmds:
      - docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest git file:///pwd --only-verified --fail

  ci:
    desc: Generate GitHub Action
    summary: |
      Generate a standardized trufflehog GitHub Action configuration.
      This configuration is auto-generated and should not be manually modified as it can be overwritten.
      
      The generated file should be excluded from commits.
    vars:
      GITHUBACTION_FILENAME: '{{.GITHUBACTION_FILENAME | default .DEFAULT_TRUFFLEHOG_GITHUBACTION_FILENAME}}'
    cmds:
      - mkdir -p $(dirname "{{.GITHUBACTION_FILENAME}}")
      - echo "${GITHUBACTION_CONTENT}" > "{{.GITHUBACTION_FILENAME}}"
    env:
      GITHUBACTION_CONTENT: |
        # THIS FILE HAS BEEN GENERATED BY THE COMMAND `{{.TASK}}`; DO NOT EDIT;
        name: trufflehog
        on:
          pull_request:
          push:
          workflow_dispatch:
          schedule:
            - cron: "0 4 * * *" # run once a day at 4 AM
        
        jobs:
          test:
            runs-on: ubuntu-latest
            steps:
              - name: Checkout code
                uses: actions/checkout@v4
                with:
                  fetch-depth: 0
              - name: Secret Scanning
                uses: trufflesecurity/trufflehog@main
                with:
                  extra_args: --only-verified